# Database is managed independently via Makefile for dev/test
# Run: make db-start && make db-init
# In production, database is external (managed service)

services:
  fastDataApi:
    profiles: ["fastapi", "both"]
    image: pmcgee/accessible-fast-data-api:latest
    container_name: accessible-fast-data-api
    platform: linux/amd64
    environment:
      - DB_SERVER=host.docker.internal
      - DB_PORT=1433
      - DB_NAME=starsongs
      - DB_USER=sa
      - DB_PASSWORD=YourStrong@Passw0rd
      - DB_POOL_SIZE=${DB_POOL_SIZE:-20}
      - DB_POOL_MAX_OVERFLOW=${DB_POOL_MAX_OVERFLOW:-10}
      - DB_POOL_TIMEOUT=${DB_POOL_TIMEOUT:-30}
      - DB_POOL_RECYCLE=${DB_POOL_RECYCLE:-3600}
      - DB_POOL_PRE_PING=${DB_POOL_PRE_PING:-true}
      - DB_SQL_ECHO=${DB_SQL_ECHO:-false}
      - CORS_ORIGINS=${CORS_ORIGINS:-http://localhost,http://localhost:80,http://localhost:3000}
    ports:
      - "8000:8000"
    restart: unless-stopped

  flaskDataApi:
    profiles: ["flask", "both"]
    image: pmcgee/accessible-flask-data-api:latest
    container_name: accessible-flask-data-api
    platform: linux/amd64
    environment:
      - DB_SERVER=host.docker.internal
      - DB_PORT=1433
      - DB_NAME=starsongs
      - DB_USER=sa
      - DB_PASSWORD=YourStrong@Passw0rd
      - DB_POOL_SIZE=${DB_POOL_SIZE:-20}
      - DB_POOL_MAX_OVERFLOW=${DB_POOL_MAX_OVERFLOW:-10}
      - DB_POOL_TIMEOUT=${DB_POOL_TIMEOUT:-30}
      - DB_POOL_RECYCLE=${DB_POOL_RECYCLE:-3600}
      - DB_POOL_PRE_PING=${DB_POOL_PRE_PING:-true}
      - DB_SQL_ECHO=${DB_SQL_ECHO:-false}
      - CORS_ORIGINS=${CORS_ORIGINS:-http://localhost,http://localhost:80,http://localhost:3000}
    ports:
      - "8001:8001"
    restart: unless-stopped

  nextui:
    image: pmcgee/accessible-nextui:latest
    container_name: accessible-nextui
    platform: linux/amd64
    environment:
      # Configure which API to use: fastDataApi:8000 or flaskDataApi:8001
      - NEXT_PUBLIC_SONGDATA_API_URL=${API_SERVICE_URL:-http://fastDataApi:8000}
    ports:
      - "80:3000"
    restart: unless-stopped
